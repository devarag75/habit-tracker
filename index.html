<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Monthly Habit Tracker Pro</title>

<style>
:root {
  --bg: #eef2ff;
  --card: rgba(255,255,255,0.95);
  --text: #111;
  --grid: #ddd;
  --accent: #6366f1;
}

body.dark {
  --bg: #0f172a;
  --card: #111827;
  --text: #e5e7eb;
  --grid: #374151;
  --accent: #22d3ee;
}

body {
  margin: 0;
  font-family: system-ui, sans-serif;
  background: linear-gradient(135deg, var(--bg), #f8fafc);
  color: var(--text);
}

.app { padding: 18px; }

.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.badge {
  background: #22c55e;
  color: white;
  padding: 6px 10px;
  border-radius: 999px;
  font-size: 12px;
}

.toggle {
  background: var(--accent);
  color: white;
  border: none;
  padding: 6px 10px;
  border-radius: 8px;
  cursor: pointer;
}

.layout {
  display: grid;
  grid-template-columns: 62% 38%;
  gap: 14px;
}

.card {
  background: var(--card);
  border-radius: 14px;
  padding: 12px;
  box-shadow: 0 8px 22px rgba(0,0,0,.15);
}

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 11px;
}

th, td {
  border: 1px solid var(--grid);
  padding: 4px;
  text-align: center;
}

th {
  background: rgba(0,0,0,0.03);
}

td.done { background: #22c55e; color: white; }
td.missed { background: #7f1d1d; color: #fecaca; }
td.today { outline: 2px solid var(--accent); }

.delete {
  color: #ef4444;
  cursor: pointer;
  margin-left: 6px;
}

.spark {
  width: 60px;
  height: 18px;
}

canvas {
  display: block;
  width: 100%;
}
</style>
</head>

<body>
<div class="app">

<div class="header">
  <h2>üìò Monthly Habit Tracker</h2>
  <div>
    <button class="toggle" onclick="toggleTheme()">üåô</button>
    <span class="badge" id="percent">0%</span>
  </div>
</div>

<div class="layout">
  <div class="card">
    <table id="grid"></table>
  </div>

  <div class="card">
    <canvas id="mainGraph" width="600" height="300"></canvas>
  </div>
</div>

</div>

<script>
const DAYS = 31;
const STORAGE = "habit_tracker_fixed";

let state = JSON.parse(localStorage.getItem(STORAGE)) || {
  dark: false,
  habits: ["Wake up early","Study","Coding","Exercise","No gaming"],
  data: {}
};

document.body.classList.toggle("dark", state.dark);

const grid = document.getElementById("grid");
const mainCanvas = document.getElementById("mainGraph");
const ctx = mainCanvas.getContext("2d");
const percent = document.getElementById("percent");

function save(){ localStorage.setItem(STORAGE, JSON.stringify(state)); }

function toggleTheme(){
  state.dark = !state.dark;
  document.body.classList.toggle("dark", state.dark);
  save();
}

function monthKey(){
  return new Date().toISOString().slice(0,7);
}

function build(){
  const m = monthKey();
  state.data[m] ||= {};
  const today = new Date().getDate();

  let html = `<tr><th>Habit</th><th>üìà</th>`;
  for(let d=1; d<=DAYS; d++) html += `<th>${d}</th>`;
  html += "</tr>";

  state.habits.forEach(h => {
    html += `<tr>
      <th>${h}<span class="delete" onclick="deleteHabit('${h}')">‚úñ</span></th>
      <td><canvas class="spark" id="s_${h}" width="60" height="18"></canvas></td>`;

    for(let d=1; d<=DAYS; d++){
      const k = h+"_"+d;
      const v = state.data[m][k];
      const past = d < today;

      html += `<td class="${v?'done':past?'missed':''}"
        ${!past ? `onclick="toggle('${h}',${d})"` : ""}>
        ${v?'‚úî':past?'‚ùå':''}
      </td>`;
    }
    html += "</tr>";
  });

  grid.innerHTML = html;
  drawMainGraph();
  state.habits.forEach(drawSpark);
  updatePercent();
}

function toggle(h,d){
  const m = monthKey();
  const k = h+"_"+d;
  state.data[m][k] = !state.data[m][k];
  save(); build();
}

function deleteHabit(h){
  if(!confirm(`Delete "${h}"?`)) return;
  state.habits = state.habits.filter(x => x !== h);
  Object.values(state.data).forEach(month =>
    Object.keys(month).forEach(k => k.startsWith(h+"_") && delete month[k])
  );
  save(); build();
}

function drawMainGraph(){
  ctx.clearRect(0,0,600,300);
  ctx.beginPath();
  ctx.strokeStyle = getComputedStyle(document.body).getPropertyValue("--accent");
  ctx.lineWidth = 1.2;

  for(let d=1; d<=DAYS; d++){
    let v = 0;
    state.habits.forEach(h => {
      if(state.data[monthKey()][h+"_"+d]) v++;
    });
    const x = (d/DAYS)*600;
    const y = 300 - v*25;
    d===1 ? ctx.moveTo(x,y) : ctx.lineTo(x,y);
  }
  ctx.stroke();
}

function drawSpark(h){
  const c = document.getElementById("s_"+h).getContext("2d");
  c.clearRect(0,0,60,18);
  c.beginPath();
  c.strokeStyle = "#22c55e";
  c.lineWidth = 1;

  for(let d=1; d<=DAYS; d++){
    const v = state.data[monthKey()][h+"_"+d];
    const x = (d/DAYS)*60;
    const y = v ? 4 : 14;
    d===1 ? c.moveTo(x,y) : c.lineTo(x,y);
  }
  c.stroke();
}

function updatePercent(){
  const m = monthKey();
  let total = DAYS * state.habits.length, done = 0;
  Object.values(state.data[m]).forEach(v => v && done++);
  percent.textContent = Math.round((done/total)*100) + "%";
}

build();
</script>
</body>
</html>
